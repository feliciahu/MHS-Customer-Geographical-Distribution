USE ROLE SBX_EA_GENERAL_FR;
USE SECONDARY ROLES ALL;

-- SELECT DISTINCT "Customer Segment" FROM SBX_PSAS_DB.SALES_OPS_GOV.T_SFDC_PHARMA2_PHARMA_ACCT_MSTR WHERE "Common Group Name" = 'GOVERNMENT-PPV';


-- SELECT TOP 10* FROM SBX_PSAS_DB.SALES_OPS_GOV.V_PHARMA_ACCT_MSTR_SALES
-- use role PRD_PSAS_SALES_OPS_ANALYST_FR

-- SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.MHS_PHARMA_ACCT_MSTR_REV;

CREATE OR REPLACE TEMPORARY TABLE REVENUE AS (

--PULL ANNUAL REVENUE
SELECT    m.CUST_ACCT_ID,
          SUM(NET_VALUE_AMT) NET_SLS
FROM      PRD_PSAS_ANALYTICS_DB.GOLD_SALES.VW_DLY_ACCT_SLS s
JOIN      PRD_PSAS_ANALYTICS_DB.GOLD_MASTER.VW_CUST_MSTR m
ON        m.CUST_ACCT_ID = s.CUST_ACCT_ID
AND       m.CURRENT_RECORD_IND = 'Y'
WHERE     POST_DT BETWEEN DATEADD(MONTH, -13, DATE_TRUNC('MONTH', CURRENT_DATE())) AND  DATEADD(DAY, -1, DATE_TRUNC('MONTH', DATEADD(MONTH,-1,CURRENT_DATE())))
GROUP BY  m.CUST_ACCT_ID);

CREATE OR REPLACE TABLE SBX_PSAS_DB.SALES_OPS_GOV.MHS_PHARMA_ACCT_MSTR_REV AS                            
SELECT A.*,
B. NET_SLS AS ANNUAL_REVENUE_NEW
FROM SBX_PSAS_DB.SALES_OPS_GOV.T_SFDC_PHARMA2_PHARMA_ACCT_MSTR A
LEFT JOIN REVENUE B
ON LTRIM(A."Account Number",'0')=LTRIM(B.CUST_ACCT_ID,'0')
WHERE A."Customer Segment"='MHS'
AND A."AVP Name" IN ('Ken McIsaac','Chris Naughton','Ginger Thorpe','Ross Hayes');

-- SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.MHS_PHARMA_ACCT_MSTR_REV;