-- USE ROLE SBX_EA_GENERAL_FR;
-- USE SECONDARY ROLES ALL;

-- SELECT DISTINCT "Customer Segment" FROM SBX_PSAS_DB.SALES_OPS_GOV.T_SFDC_PHARMA2_PHARMA_ACCT_MSTR WHERE "Common Group Name" = 'GOVERNMENT-PPV';
-- SELECT TOP 10* FROM SBX_PSAS_DB.SALES_OPS_GOV.V_PHARMA_ACCT_MSTR_SALES
-- SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.MHS_PHARMA_ACCT_MSTR_REV;

-- ****************REV_PREP TABLE IS REFRESHED DAILY AS A TABLEAU PREP FLOW IN THE TABLEAU SERVER FIELD SALES FOLDER. FLOW IS ALSO SAVED IN GITHUB ***********************

-- CREATE OR REPLACE TABLE SBX_PSAS_DB.SALES_OPS_GOV.MHS_PHARMA_ACCT_MSTR_REV_PREP AS (
-- --PULL ANNUAL REVENUE
-- SELECT    m.CUST_ACCT_ID,
--           SUM(NET_VALUE_AMT) NET_SLS
-- FROM      PRD_PSAS_ANALYTICS_DB.GOLD_SALES.VW_DLY_ACCT_SLS s
-- JOIN      PRD_PSAS_ANALYTICS_DB.GOLD_MASTER.VW_CUST_MSTR m
-- ON        m.CUST_ACCT_ID = s.CUST_ACCT_ID
-- AND       m.CURRENT_RECORD_IND = 'Y'
-- WHERE     POST_DT BETWEEN DATEADD(MONTH, -13, DATE_TRUNC('MONTH', CURRENT_DATE())) AND  DATEADD(DAY, -1, DATE_TRUNC('MONTH', DATEADD(MONTH,-1,CURRENT_DATE())))
-- GROUP BY  m.CUST_ACCT_ID);


--DAILY TASK FOR THE DASHBOARD REFRESH

--SHOW TASKS LIKE 'TSK_FELICIA_H_MHS_GEO_DIST%';
--DESC TASK TSK_FELICIA_H_MHS_GEO_DIST;
select *  from table(SBX_PSAS_DB.INFORMATION_SCHEMA.task_history(
    scheduled_time_range_start=>dateadd('hour',-24,current_timestamp()),
    result_limit => 10,
    task_name=>'TSK_FELICIA_H_MHS_GEO_DIST'));
    
--alter task TSK_FELICIA_H_MHS_GEO_DIST resume; --It was by default suspended  ( run this command Only first time since by default its suspended)
-- execute task TSK_FELICIA_H_MHS_GEO_DIST;

--TASK
CREATE OR REPLACE TASK TSK_FELICIA_H_MHS_GEO_DIST

WAREHOUSE = SBX_EA_GENERAL_FR_WH
SCHEDULE = 'USING CRON 50 6 * * 0-6 America/Chicago' -- 6:50 AM on weekdays
TIMESTAMP_INPUT_FORMAT = 'YYYY-MM-DD HH24'
AS

CREATE OR REPLACE TABLE SBX_PSAS_DB.SALES_OPS_GOV.MHS_PHARMA_ACCT_MSTR_REV AS

WITH FINAL AS (
                          
SELECT A.*,
B. NET_SLS AS ANNUAL_REVENUE_NEW
FROM SBX_PSAS_DB.SALES_OPS_GOV.T_SFDC_PHARMA2_PHARMA_ACCT_MSTR A
LEFT JOIN SBX_PSAS_DB.SALES_OPS_GOV.MHS_PHARMA_ACCT_MSTR_REV_PREP B
ON LTRIM(A."Account Number",'0')=LTRIM(B.CUST_ACCT_ID,'0')
WHERE A."Customer Segment"='MHS'
AND A."AVP Name" IN ('Ken McIsaac','Chris Naughton','Ginger Thorpe','Ross Hayes')
)

SELECT * FROM FINAL

-- SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.MHS_PHARMA_ACCT_MSTR_REV;